# 入退室管理アプリImasuの開発ログ


## フロントエンド
### 📝 開発アプローチ（AIとのペアプログラミング）
本フロントエンド開発は、主にAIアシスタント（Gemini）をコーディングパートナーとして活用し、対話型で構築を進めた。
開発途中で発生したエラー（HTTPメソッドの不一致、データ型の相違、変数名のズレ等）のほとんどは、バックエンドのスキーマ設計やAPI仕様のAI側への伝達漏れ・認識のズレが原因であった。ログやエラーメッセージから原因を特定し、AIに追加のコンテキスト（`schemas.py`や`models.py`の仕様など）を正確に伝えることで、迅速にバグを修正・連携させるアプローチをとった。

### 🛠 導入技術・インストールした主要パッケージ
バックエンド（FastAPI）と通信するSPA（Single Page Application）として構築。

* **フレームワーク / ビルドツール:**
  * `react` / `react-dom` : UI構築のコアライブラリ
  * `vite` : 高速な開発環境・ビルドツール
* **ルーティング:**
  * `react-router-dom` : クライアントサイドの画面遷移（SPAルーティング）、及び未認証ユーザーのリダイレクト（ProtectedRoute）管理
* **HTTP通信:**
  * `axios` : REST APIとの非同期通信。インターセプターを用いてリクエストヘッダーにJWTトークンを自動付与する設定を実装
* **スタイリング / UI:**
  * `tailwindcss` / `postcss` / `autoprefixer` : ユーティリティファーストのCSSフレームワーク
  * `lucide-react` : 履歴画面やナビゲーション用の軽量・高品質なSVGアイコンセット

### 🎯 実装したコア機能（MVP）

#### 1. 認証機能（Login / Register）
* バックエンドの `OAuth2PasswordRequestForm` に準拠したログイン機能。
* `UserCreate` スキーマに基づく新規登録機能。
* **UXの工夫:** 新規登録APIが直接JWTトークンを返す仕様を活かし、「アカウント登録と同時に自動ログインし、シームレスにホーム画面へ遷移する」フローを実装。

#### 2. メインダッシュボード（Home）
* **ステータス操作:** 「入室」「退室」「外出」「戻る」の4つのアクションボタンから `POST` でログを送信。
* **リアルタイム在室一覧:** `GET /api/users?status=in`（クエリパラメータ）を活用し、現在部室にいるメンバーのみを抽出してリスト表示。

#### 3. プロフィール部分更新（Profile）
* **動的UIの実現:** `PUT` メソッドを利用した「表示名」と「テーマカラー」の更新機能。
* **ネイティブカラーピッカー:** `<input type="color">` を用い、1600万色から自由にHEXコード（`#xxxxxx`）を選択・保存可能に。
* 保存したテーマカラーを、Home画面の「自身の名前の装飾」や「在室メンバー一覧のバッジ・罫線」にインラインスタイル（`style={{}}`）を用いて動的に反映。（※Tailwindの動的クラス名生成の制約を回避するための工夫）

#### 4. 個人の入退室タイムライン（Logs）
* `GET /api/users/me/logs` から取得した履歴データを、最新順に時系列表示。
* アクション（enter, exit, go_out, return）に応じて、`lucide-react` のアイコンとカラーリングを動的に切り替えて表示。

#### 5. ボトムナビゲーション（App）
* スマホアプリを意識した画面下部固定のメニューバーを実装し、「ホーム」「履歴」「設定」へのスムーズなアクセスを提供。

### 💡 今後の課題・Next Steps
* **テストの導入:** MVPフェーズでは開発スピードを優先したため、次期プロジェクトや追加機能開発時からは、初期段階で自動テスト（`pytest` や `Vitest`）の導入を検討する。
* **物理デバイス連携:** データベースに準備済みの `nfc_card_id` を活用し、学生証や交通系ICカードでのタッチ入退室機能（ハードウェア連携）を実装する。
* 本番環境へのデプロイメント（Vercel, Render等）。

## 2026-02-14: 入退室ログ機能の実装とステータス連動、API設計のRESTful化

### 1. 実装概要
* **機能:** * ユーザーの入退室ログ（Log）の作成および取得機能を追加。
  * ログのアクション（入室・退室など）に伴う、ユーザーの現在ステータス（in/out/away）の自動更新処理を実装。
  * 絞り込み条件を用いた汎用的なユーザー一覧取得機能の実装。

### 2. APIエンドポイントの設計と最適化
* **ログ関連エンドポイントの統一:**
  * `POST /api/users/me/logs`: ログインユーザーのログを作成。
  * `GET /api/users/me/logs`: ログインユーザーのログ一覧を取得。
  * ※「データのリソース（場所）」と「HTTPメソッド（行動）」を切り分けるRESTfulの思想に基づき、GETとPOSTで同一のURLを採用。
* **ユーザー一覧取得機能のRESTful化:**
  * 当初 `GET /api/get_in_users` として実装した機能を、汎用的な `GET /api/users` へリファクタリング。
  * クエリパラメータ（`?status=in` 等）を導入し、1つのエンドポイントで「全員取得」から「ステータスごとの絞り込み」まで柔軟に対応できる構造に変更。

### 3. ビジネスロジックの改善（ステータス自動連動）
* **辞書（マッピング）を活用したロジックの簡略化:**
  * ログ作成時、送られてきた `action` (Enter, exit, go_out, return) を `status` (in, out, away) に変換する `status_map`（対応表）を導入。
  * 冗長な `if-elif` 文を排除し、拡張性と保守性の高いコードを実現。
* **トランザクションの安全性確保:**
  * 「ログの新規追加」と「ユーザー情報のステータス上書き」という2つのDB操作を、最後に1回の `db.commit()` で同時に確定する設計を採用。不整合データの発生を防止。

### 4. トラブルシューティング履歴
* **FastAPIの引数順序ルール:**
  * エンドポイント関数において「デフォルト値を持たない引数（Pydanticスキーマ等）」は「デフォルト値を持つ引数（`Depends`等）」より先に記述しなければならないPythonの言語仕様を学習・適用。
* **Pydantic Validation Error (スペルミス):**
  * DBモデル側（`date_last_updated_log`）とスキーマ側（`date_last_update_log`）の命名不一致によりバリデーションエラーが発生。スキーマ側のプロパティ名を修正して解決。



## 2026-02-12(Day4): ユーザー情報更新機能の実装とAPI設計の最適化

### 1. 実装概要
* **機能:** ログイン中のユーザー自身によるプロフィール情報（表示名、テーマカラー）の更新。
* **メソッド:** `PUT` メソッドを採用（リソースの更新）。
* **エンドポイント設計:**
    * プロフィール情報（名前、色など）と、システム情報（学籍番号、NFC IDなど）の更新口を分離する設計方針を決定。

### 2. 環境・構成の修正
* **ディレクトリ構成:** `backend/__init__.py` を削除。
    * 理由: `fastapi dev` コマンド等がパッケージ構成を誤認し、インポートエラーを引き起こすのを防ぐため。

### 3. API設計とセキュリティ対策
* **レスポンスのフィルタリング (重要):**
    * `main.py` のデコレータに `response_model=_schemas.User` を明示的に指定。
    * `schemas.py` の `User` クラスから `hashed_password` を除外。
    * これにより、DBオブジェクトにはパスワードが含まれていても、APIレスポンスの時点で自動的に削除される安全な構成を確立。
* **Pydantic V2対応:**
    * Swagger UI 上で `client_id` や `grant_type` 等が表示されるのは仕様であることを確認（無視して運用）。
    * `UserBaseUpdate` 等のスキーマで `str | None = None` を使用し、送信されなかった項目は更新しない（None）柔軟な設計を採用。


## 2026-02-11(Day3)
### 1. 実装概要
* **機能:** ユーザー登録、ログイン（トークン発行）、現在ログイン中のユーザー取得。
* **方式:** JWT (JSON Web Token) を利用したステートレス認証。
* **セキュリティ:**
    * パスワードは `bcrypt` でハッシュ化して保存。
    * トークンには `id` と `email` のみを含め、有効期限を30日に設定（サークルアプリの利便性重視）。
    * アルゴリズムは `HS256` を明示的に指定。

#### 2. 依存ライブラリのバージョン固定 (重要)
`passlib` と最新の `bcrypt` (v4.0+) の相性問題により `AttributeError` が発生するため、`bcrypt` のバージョンを固定。
```bash
pip uninstall bcrypt
pip install "bcrypt==3.2.0"
```




### 2026-02-10(Day2)
### 1. データベース設計 (models.py)

#### 設計のポイント
1.  **SQLite + SQLAlchemy** を採用。
    * 将来的な拡張（PostgreSQL等への移行）を見越し、ORMを利用。
2.  **ユーザー状態管理 (`status`) の導入**
    * **「在室中(in) / 帰宅(out)」** を管理する専用カラムを作成。
    * これにより、リアルタイムな在室状況の取得を高速化（`status="in"` で検索可能）。
3.  **ログ管理 (`action`) の明確化**
    * ユーザーの状態と区別するため、カラム名を `status` から `action` に変更。
    * 値は可読性を重視し、整数ではなく文字列（"enter", "exit" 等）を採用。
4.  **セキュリティと利便性のバランス**
    * パスワードはハッシュ化（`bcrypt`）。
    * 学籍番号（`original_id`）や学生証ID（`nfc_card_id`）は**平文保存**し、検索・デバッグを容易に。
    * パスワード検証ロジックをモデル内にカプセル化（`verify_password`）。
5.  **日時管理の自動化**
    * `func.now()` を使用し、DBサーバー側で作成日時・更新日時を自動管理。

### 2. Pydanticスキーマ設計 (schemas.py)

#### 設計のポイント
* **2段階登録フローへの対応**
    * `UserCreate`: アカウント作成用（メール・パスワードのみ）。
    * `UserBaseUpdate`: プロフィール登録・更新用（表示名、学籍番号など）。
    * これにより、「まずは登録 → 後から情報入力」という柔軟なUXを実現。
* **更新用スキーマの独立定義**
    * `UserBase` を継承せず、全フィールドを `Optional (str | None)` で定義。
    * `email` 等の変更不可項目を含めないことで、セキュリティを向上（Partial Updateの実現）。
* **出力用スキーマの整合性**
    * DB上のカラム（`role`, `color_code` 等）にはデフォルト値があるため、出力時は `Optional` ではなく必須項目（`str`）として定義。
    * 不要な `is_active` フィールドを削除し、代わりに `status` フィールドを追加してモデルとの整合性を確保。


## 2026-02-09(Day1)
gitignore, backend 作成  
前回のAwesome Lead Managerでは動画公開時のバージョンに固定することで、動画と同じ書き方をしてもエラーが出ないようにしていたが、今回は今後のことも考えて最新版で作成することにした。

```bash
python3 -m venv venv
source venv/bin/activate

pip install "fastapi[standard]" sqlalchemy alembic pydantic-settings python-dotenv passlib[bcrypt] pyjwt
```

### schemas.pyについて
- 継承で楽をしている
- フロントエンドから入ってくるデータと、フロントエンドへ出力するデータで構造を分けている。
    - 例えば、ユーザ登録のときに送られてくるのは**email**と**hashed_password**で、未登録だから{id}はない
    - 逆にフロントエンドに戻すときはパスワードを送る必要はないから**email**と**id**を送る
- SQLAlchemyのオブジェクト（クラス形式のデータ）```data['id']```を、Pydanticが解釈可能な形式```data.id```に自動翻訳するためのスイッチが必要  
**Pydantic V1とV2では書き方が違う**  
ex. V1
```python
class User(_UserBase):
    id: int

    class Config:
        orm_mode = True
```
ex. V2
```python
model_config = ConfigDict(from_attributes=True)
```

### model.pyでのプロトタイプからの変更点

### 変更点・設計判断
1.  **Userモデル: `original_id` の型変更**
    * **変更前:** `Integer`
    * **変更後:** `String`
    * **理由:** 学籍番号（例: `1X99...`）や社員番号など、アルファベットが含まれる場合や先頭が `0` で始まる番号に対応するため。

2.  **Userモデル: `display_name` の制約緩和**
    * **変更:** `unique=True` を削除（推奨）
    * **理由:** 同姓同名ユーザーや、同じニックネームを使用したいユーザーが登録できなくなるのを防ぐため。

3.  **Logモデル: 日時管理の最適化**
    * **変更前:** Python側の `datetime.utcnow` を使用
    * **変更後:** SQLAlchemyの `func.now()` を使用（`server_default`, `onupdate`）
    * **理由:**
        * Python 3.12以降の `datetime.utcnow` 非推奨警告を回避するため。
        * DBサーバーの時刻を正とし、タイムゾーンのブレを防ぐため。
        * `onupdate` により、レコード更新時に自動的に `date_last_updated` が書き換わるようにするため。